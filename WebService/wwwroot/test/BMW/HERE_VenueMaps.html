<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
    <meta name="description" content="Here Venues API ot load and visualize data on the map">
    <title>Display Venues on map</title>
    <link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />


    <style>
      * {
        box-sizing: border-box;
      }
      
      /* Create two equal columns that floats next to each other */
      .column {
        float: left;
        width: 50%;
        padding: 10px;
        height: 300px; /* Should be removed. Only for demonstration */
      }
      
      /* Clear floats after the columns */
      .row:after {
        content: "";
        display: table;
        clear: both;
      }
      
      /* Responsive layout - makes the two columns stack on top of each other instead of next to each other */
      @media screen and (max-width: 600px) {
        .column {
          width: 100%;
        }
      }
      </style>

    <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-venues.js"></script>

    <!-- <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/chart.js@3.5.1/dist/chart.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- <script type="text/javascript" src="../../json/BMW/detections.js"></script> -->





  <body>

    <!-- <h2>Responsive Two Column Layout</h2>
    <p>Resize the browser window to see the responsive effect (the columns will stack on top of each other instead of floating next to each other, when the screen is less than 600px wide).</p>
     -->
    <div class="row">
      <div class="column">
        <h2>Map</h2>
        <div id="map" style="width: 47vw; height: 90vh;"></div>
      </div>
      <div class="column">
        <h2>Analytics</h2>
        <div>
          <canvas id="chart_DetectionsTypesCounts"></canvas>
          <canvas id="chart_DetectionsSubTypesCounts"></canvas>
        </div>
      </div>
    </div>
    


    <!-- <h1>WaliedCheetos - Display Venues</h1>

  <div id="map" style="height: 900px; width: 1300px;"></div>
  <input type="button" value="Add points in venue" onclick="addVenueLocations();">  </input>

  <div>
    <canvas id="chart_DetectionsTypesCounts"></canvas>
    <canvas id="chart_DetectionsSubTypesCounts"></canvas>
  </div> -->

    <script type="text/javascript">


//#region
/*
Track NFC special tool in coorelation with the person within the venue map
*/
//#endregion

//#region globals configs

var detections = {
    WaliedCheetos:{
    detections:[
        {
            id:"detect_01",
            object:{
                "type":"vehicle",
                "subtype":"light vehicle",
                id:"obj_01"
            },
            location:{
                venue_info:{
                    id:"venue_01",
                    name:"WaliedCheetos_Venue_01",
                    level:1,
                    space:"bathroom"
                },
                coordinates:"x1, y1"
            },
            timestamp:"",
            timestamp:"#WaliedCheetos|#BMW|#AGMC"
        },
        {
            id:"detect_02",
            object:{
                "type":"vehicle",
                "subtype":"heavy vehicle",
                id:"obj_02"
            },
            location:{
                venue_info:{
                    id:"venue_01",
                    name:"WaliedCheetos_Venue_01",
                    level:1,
                    space:"retail"
                },
                coordinates:"x2, y2"
            },
            timestamp:"",
            timestamp:"#WaliedCheetos|#BMW|#AGMC"
        },
        {
            id:"detect_03",
            object:{
                "type":"person",
                "subtype":"safety engineer",
                id:"obj_03"
            },
            location:{
                venue_info:{
                    id:"venue_01",
                    name:"WaliedCheetos_Venue_01",
                    level:1,
                    space:"retail"
                },
                coordinates:"x3, y3"
            },
            timestamp:"",
            timestamp:"#WaliedCheetos|#BMW|#AGMC"
        },
        {
            id:"detect_04",
            object:{
                "type":"person",
                "subtype":"maintenance engineer",
                id:"obj_04"
            },
            location:{
                venue_info:{
                    id:"venue_01",
                    name:"WaliedCheetos_Venue_01",
                    level:1,
                    space:"retail"
                },
                coordinates:"x4, y4"
            },
            timestamp:"",
            timestamp:"#WaliedCheetos|#BMW|#AGMC"
        },
        {
            id:"detect_05",
            object:{
                "type":"person",
                "subtype":"service engineer",
                id:"obj_05"
            },
            location:{
                venue_info:{
                    id:"venue_01",
                    name:"WaliedCheetos_Venue_01",
                    level:1,
                    space:"retail"
                },
                coordinates:"x5, y5"
            },
            timestamp:"",
            timestamp:"#WaliedCheetos|#BMW|#AGMC"
        },
        {
            id:"detect_06",
            object:{
                "type":"person",
                "subtype":"vehicle owner",
                id:"obj_06"
            },
            location:{
                venue_info:{
                    id:"venue_01",
                    name:"WaliedCheetos_Venue_01",
                    level:1,
                    space:"retail"
                },
                coordinates:"x6, y6"
            },
            timestamp:"",
            timestamp:"#WaliedCheetos|#BMW|#AGMC"
        }
    ],
    vehciles_types:["light vehicle", "heavy vehicle"],
    persons_types:["safety engineer", "service engineer", "vehicle owner"]
}
}

var initialDetections = {
    WaliedCheetos:{
    detections:[
        {
            id:"detect_01",
            object:{
                type:"vehicle",
                subtype:"light vehicle",
                id:"obj_01"
            },
            location:{
                venue_info:{
                    id:"venue_01",
                    name:"WaliedCheetos_Venue_01",
                    level:1,
                    space:"bathroom"
                },
                coordinates:{lat:47.4523, lng:8.5612}
            },
            timestamp:"",
            timestamp:"#WaliedCheetos|#BMW|#AGMC"
        },
        {
            id:"detect_02",
            object:{
                "type":"vehicle",
                "subtype":"heavy vehicle",
                id:"obj_02"
            },
            location:{
                venue_info:{
                    id:"venue_01",
                    name:"WaliedCheetos_Venue_01",
                    level:1,
                    space:"retail"
                },
                coordinates:{lat:47.4523, lng:8.5613}
            },
            timestamp:"",
            timestamp:"#WaliedCheetos|#BMW|#AGMC"
        },
        {
            id:"detect_03",
            object:{
                "type":"person",
                "subtype":"safety engineer",
                id:"obj_03"
            },
            location:{
                venue_info:{
                    id:"venue_01",
                    name:"WaliedCheetos_Venue_01",
                    level:1,
                    space:"retail"
                },
                coordinates:{lat:47.4536, lng:8.5615}
            },
            timestamp:"",
            timestamp:"#WaliedCheetos|#BMW|#AGMC"
        },
        {
            id:"detect_04",
            object:{
                "type":"person",
                "subtype":"maintenance engineer",
                id:"obj_04"
            },
            location:{
                venue_info:{
                    id:"venue_01",
                    name:"WaliedCheetos_Venue_01",
                    level:1,
                    space:"retail"
                },
                coordinates:{lat:47.4529, lng:8.5611}
            },
            timestamp:"",
            timestamp:"#WaliedCheetos|#BMW|#AGMC"
        },
        {
            id:"detect_05",
            object:{
                "type":"person",
                "subtype":"service engineer",
                id:"obj_05"
            },
            location:{
                venue_info:{
                    id:"venue_01",
                    name:"WaliedCheetos_Venue_01",
                    level:1,
                    space:"retail"
                },
                coordinates:{lat:47.4515, lng:8.5613}
            },
            timestamp:"",
            timestamp:"#WaliedCheetos|#BMW|#AGMC"
        },
        {
            id:"detect_06",
            object:{
                "type":"person",
                "subtype":"vehicle owner",
                id:"obj_06"
            },
            location:{
                venue_info:{
                    id:"venue_01",
                    name:"WaliedCheetos_Venue_01",
                    level:1,
                    space:"retail"
                },
                coordinates:{lat:47.4515, lng:8.5608}
            },
            timestamp:"",
            timestamp:"#WaliedCheetos|#BMW|#AGMC"
        }
    ],
    vehciles_types:["light vehicle", "heavy vehicle"],
    persons_types:["safety engineer", "service engineer", "vehicle owner"]
}
};

var chart_DetectionsTypesCounts;
var chart_DetectionsSubTypesCounts;

//#endregion



//#region after map load logic

var dynamicColors = function() {
    var r = Math.floor(Math.random() * 255);
    var g = Math.floor(Math.random() * 255);
    var b = Math.floor(Math.random() * 255);
    return "rgb(" + r + "," + g + "," + b + ")";
}

/**
 * function desc.
 *
 * @param  {} parameter desc.
 */
function addDetections(){
  try {
    // create SVG Dom Icon
  var svg = `<svg xmlns="http://www.w3.org/2000/svg" class="svg-icon" width="10px" height="10px">
    <circle cx="5" cy="5" r="4" fill="rgb(250, 127, 0)" stroke-width="1" stroke="black" opacity="1"/>
    </svg>`,


    svgAnimatedPerson = '<svg id="mePin" xmlns="http://www.w3.org/2000/svg" width="43.3" height="42.4" viewBox="0 0 43.3 42.4"><path class="ring_outer" fill="#878787" d="M28.6 23c6.1 1.4 10.4 4.4 10.4 8 0 4.7-7.7 8.6-17.3 8.6-9.6 0-17.4-3.9-17.4-8.6 0-3.5 4.2-6.5 10.3-7.9.7-.1-.4-1.5-1.3-1.3C5.5 23.4 0 27.2 0 31.7c0 6 9.7 10.7 21.7 10.7s21.6-4.8 21.6-10.7c0-4.6-5.7-8.4-13.7-10-.8-.2-1.8 1.2-1 1.4z"/><path class="ring_inner" fill="#5F5F5F" d="M27 25.8c2 .7 3.3 1.8 3.3 3 0 2.2-3.7 3.9-8.3 3.9-4.6 0-8.3-1.7-8.3-3.8 0-1 .8-1.9 2.2-2.6.6-.3-.3-2-1-1.6-2.8 1-4.6 2.7-4.6 4.6 0 3.2 5.1 5.7 11.4 5.7 6.2 0 11.3-2.5 11.3-5.7 0-2-2.1-3.9-5.4-5-.7-.1-1.2 1.3-.7 1.5z"/><path class="mePin" d="M21.6 8.1a4 4 0 0 0 4-4 4 4 0 0 0-4-4.1 4.1 4.1 0 0 0-4.1 4 4 4 0 0 0 4 4.1zm4.9 8v-3.7c0-1.2-.6-2.2-1.7-2.6-1-.4-1.9-.6-2.8-.6h-.9c-1 0-2 .2-2.8.6-1.2.4-1.8 1.4-1.8 2.6V16c0 .9 0 2 .2 2.8.2.8.8 1.5 1 2.3l.2.3.4 1 .1.8.2.7.6 3.6c-.6.3-.9.7-.9 1.2 0 .9 1.4 1.7 3.2 1.7 1.8 0 3.2-.8 3.2-1.7 0-.5-.3-.9-.8-1.2l.6-3.6.1-.7.2-.8.3-1 .1-.3c.3-.8 1-1.5 1.1-2.3.2-.8.2-2 .2-2.8z" fill="#282828"/></svg>';

    // Define a variable holding SVG mark-up that defines an animated icon image:
 animatedSvg =
    '<svg version="1.1" xmlns="http://www.w3.org/2000/svg" x="0px" ' + 
    'y="0px" style="margin:-112px 0 0 -32px" width="136px"' + 
    'height="150px" viewBox="0 0 136 150"><ellipse fill="#000" ' +
    'cx="32" cy="128" rx="36" ry="4"><animate attributeName="cx" ' + 
    'from="32" to="32" begin="0s" dur="1.5s" values="96;32;96" ' + 
    'keySplines=".6 .1 .8 .1; .1 .8 .1 1" keyTimes="0;0.4;1"' + 
    'calcMode="spline" repeatCount="indefinite"/>' +    
    '<animate attributeName="rx" from="36" to="36" begin="0s"' +
    'dur="1.5s" values="36;10;36" keySplines=".6 .0 .8 .0; .0 .8 .0 1"' + 
    'keyTimes="0;0.4;1" calcMode="spline" repeatCount="indefinite"/>' +
    '<animate attributeName="opacity" from=".2" to=".2"  begin="0s" ' +
    ' dur="1.5s" values=".1;.7;.1" keySplines=" .6.0 .8 .0; .0 .8 .0 1" ' +
    'keyTimes=" 0;0.4;1" calcMode="spline" ' +
    'repeatCount="indefinite"/></ellipse><ellipse fill="#1b468d" ' +
    'cx="26" cy="20" rx="16" ry="12"><animate attributeName="cy" ' +
    'from="20" to="20" begin="0s" dur="1.5s" values="20;112;20" ' +
    'keySplines=".6 .1 .8 .1; .1 .8 .1 1" keyTimes=" 0;0.4;1" ' +
    'calcMode="spline" repeatCount="indefinite"/> ' +
    '<animate attributeName="ry" from="16" to="16" begin="0s" ' + 
    'dur="1.5s" values="16;12;16" keySplines=".6 .0 .8 .0; .0 .8 .0 1" ' +
    'keyTimes="0;0.4;1" calcMode="spline" ' +
    'repeatCount="indefinite"/></ellipse></svg>';

    var svgAnimated = `<svg xmlns="http://www.w3.org/2000/svg" version="1.1"> 
<g fill="none" stroke-width="3" transform="translate(11,11)">
<circle id="my-circle" cx="0" cy="0" r="9" stroke="darkorange" fill="seagreen" />
<animate href="#my-circle" attributeName="opacity"  values="1;-2" dur="1s" repeatCount="indefinite" /> </g> </svg>`;

    domIcon = new H.map.DomIcon(svg),
    carIcon = new H.map.Icon('../../images/BMW/car.png'),
    animatedDomIcon = new H.map.DomIcon(svgAnimated);
    markers_BasementFloor = [],
    markers_FirstFloor = [],
    markers_SecondFloor = [],

     initialInputs = {
    WaliedCheetos:{
    detections:[
        {
            id:"detect_01",
            object:{
                type:"vehicle",
                subtype:"light vehicle",
                id:"obj_01"
            },
            location:{
                venue_info:{
                    id:"venue_01",
                    name:"WaliedCheetos_Venue_01",
                    level:1,
                    space:"bathroom"
                },
                coordinates:{lat:47.4523, lng:8.5612}
            },
            timestamp:"",
            timestamp:"#WaliedCheetos|#BMW|#AGMC"
        },
        {
            id:"detect_02",
            object:{
                "type":"vehicle",
                "subtype":"heavy vehicle",
                id:"obj_02"
            },
            location:{
                venue_info:{
                    id:"venue_01",
                    name:"WaliedCheetos_Venue_01",
                    level:1,
                    space:"retail"
                },
                coordinates:{lat:47.4523, lng:8.5613}
            },
            timestamp:"",
            timestamp:"#WaliedCheetos|#BMW|#AGMC"
        },
        {
            id:"detect_03",
            object:{
                "type":"person",
                "subtype":"safety engineer",
                id:"obj_03"
            },
            location:{
                venue_info:{
                    id:"venue_01",
                    name:"WaliedCheetos_Venue_01",
                    level:1,
                    space:"retail"
                },
                coordinates:{lat:47.4536, lng:8.5615}
            },
            timestamp:"",
            timestamp:"#WaliedCheetos|#BMW|#AGMC"
        },
        {
            id:"detect_04",
            object:{
                "type":"person",
                "subtype":"maintenance engineer",
                id:"obj_04"
            },
            location:{
                venue_info:{
                    id:"venue_01",
                    name:"WaliedCheetos_Venue_01",
                    level:1,
                    space:"retail"
                },
                coordinates:{lat:47.4529, lng:8.5611}
            },
            timestamp:"",
            timestamp:"#WaliedCheetos|#BMW|#AGMC"
        },
        {
            id:"detect_05",
            object:{
                "type":"person",
                "subtype":"service engineer",
                id:"obj_05"
            },
            location:{
                venue_info:{
                    id:"venue_01",
                    name:"WaliedCheetos_Venue_01",
                    level:1,
                    space:"retail"
                },
                coordinates:{lat:47.4515, lng:8.5613}
            },
            timestamp:"",
            timestamp:"#WaliedCheetos|#BMW|#AGMC"
        },
        {
            id:"detect_06",
            object:{
                "type":"person",
                "subtype":"vehicle owner",
                id:"obj_06"
            },
            location:{
                venue_info:{
                    id:"venue_01",
                    name:"WaliedCheetos_Venue_01",
                    level:1,
                    space:"retail"
                },
                coordinates:{lat:47.4515, lng:8.5608}
            },
            timestamp:"",
            timestamp:"#WaliedCheetos|#BMW|#AGMC"
        }
    ],
    vehciles_types:["light vehicle", "heavy vehicle"],
    persons_types:["safety engineer", "service engineer", "vehicle owner"]
}
};


//create markers

initialInputs.WaliedCheetos.detections.forEach(detection => {
        markers_FirstFloor.push(new H.map.DomMarker(detection.location.coordinates, {
        // markers_FirstFloor.push(new H.map.Marker(detection.location.coordinates, {
        // icon: carIcon
        icon: domIcon
        // icon: animatedDomIcon
      }));
    });

    
        // add markers to map
        map.addObjects(markers_FirstFloor);
        
        //logic to add map object (marker) to the current active venue
        venuesProvider.activeVenue.setMapObjects(
          markers_FirstFloor,
          venuesProvider.activeVenue.getActiveLevelIndex(),
          venuesProvider.activeVenue.getActiveDrawing()
        );  

        //# of detections per level (pie chart)
        //select distinct values of detected objects (x axis values ==> labels)
        //select counts vs distinct values of detected objects (y axis values)

        //var detectionsTypesCounts = getDetectionsTypesCounts(initialInputs);



        //# of detections per space (double column chart)
        //select distinct values of space names
        //select counts of detected objects vs eveery space name 

    // randomly update all markers positions in intervals
    
    setTimeout(updateMarkerPositions, 1500);
    setInterval(updateMarkerPositions, 5000);


        /**
    * update all markers' positions with animation using the ease function
     */
     function updateMarkerPositions() {
       var updatedDetections = [];
      markers_FirstFloor.forEach(function(marker) {

        var randomIndex = Math.floor(Math.random() * initialDetections.WaliedCheetos.detections.length);
        let randomPoint = initialDetections.WaliedCheetos.detections[randomIndex].location.coordinates;  
        updatedDetections.push(initialDetections.WaliedCheetos.detections[randomIndex]);                                          

        // update marker's position within ease function callback
        ease(
          marker.getGeometry(),
          randomPoint,
          4000,
          function(coord) {
            marker.setGeometry(coord);
          }
        )
      });

      var chartLabels = [];
      var chartData = [];

var detectionsTypesCounts = getDetectionsTypesCounts(updatedDetections);
var detectionsSubTypesCounts = getDetectionsSubTypesCounts(updatedDetections);

Object.keys(detectionsTypesCounts).forEach(function(key) {
    console.log(key, detectionsTypesCounts[key]);
    chartLabels.push(key);
    chartData.push(detectionsTypesCounts[key]);
});

chart_DetectionsTypesCounts.data.labels = chartLabels;
chart_DetectionsTypesCounts.data.datasets[0].data = chartData;
chart_DetectionsTypesCounts.update();

chartLabels.splice(0, chartLabels.length);
chartData.splice(0, chartData.length);

Object.keys(detectionsSubTypesCounts).forEach(function(key) {
    console.log(key, detectionsSubTypesCounts[key]);
    chartLabels.push(key);
    chartData.push(detectionsSubTypesCounts[key]);
});

chart_DetectionsSubTypesCounts.data.labels = chartLabels;
chart_DetectionsSubTypesCounts.data.datasets[0].data = chartData;
chart_DetectionsSubTypesCounts.update();


    }


  } catch (error) {
    console.error(error);
  }
}

function addDetections_Original(){
  try {
    // create SVG Dom Icon
  var svg = `<svg xmlns="http://www.w3.org/2000/svg" class="svg-icon" width="10px" height="10px">
    <circle cx="5" cy="5" r="4" fill="rgb(250, 127, 0)" stroke-width="1" stroke="black" opacity="1"/>
    </svg>`,
    domIcon = new H.map.DomIcon(svg),
    markers_BasementFloor = [],
    markers_FirstFloor = [],
    markers_SecondFloor = [],

    //markers_FirstFloor_Unchanged = []
    
    
    initialDetecetionsPositions_BasementFloor = [
      [49.606945, 8.368333],
      [50.98194, 12.50638],
      [51.83169, 12.19096],
      [52.19585, 14.58753],
      [51.30805, 13.55555],
      [51.36305, 11.94083],
      [51.55222, 12.05388],
      [51.29360, 13.35611],
      [53.30638, 12.75222],
      [52.58055, 13.91666],
      [52.20360, 13.15638],
      [54.03825, 12.71051],
      [50.91527, 11.71444],
      [52.91888, 12.42527],
      [52.07361, 11.62638],
      [51.36333, 14.94999],
      [53.83277, 13.66861],
      [51.88944, 14.53194],
      [51.29694, 14.12749],
      [52.38000, 13.52250],
      [51.13280, 13.76720],
      [50.97980, 10.95810],
      [50.02233, 8.57055],
      [52.13460, 7.68482],
      [53.63040, 9.98822],
      [52.47259, 13.40390],
      [50.86589, 7.14273],
      [51.22701, 6.76677],
      [48.35380, 11.7861],
      [49.49869, 11.07805],
      [51.42388, 12.23308],
      [49.21459, 7.10950],
      [48.68989, 9.22196],
      [52.35970, 13.28769],
      [52.46110, 9.68479],
      [53.04750, 8.78665],
      [49.69999, 8.64583],
      [49.94869, 7.26388],
      [49.47305, 8.51416],
      [51.03499, 8.68083]
    ];

    initialDetecetionsPositions_FirstFloor = [
    [47.4523, 8.5612]
    ,[47.4525, 8.5612]
    ,[47.4523, 8.5612]
    ,[47.4526, 8.5612]
    ,[47.4522, 8.5612]
    ,[47.4523, 8.5613]
    ,[47.4536, 8.5614]
    ,[47.4536, 8.5617]
    ,[47.4536, 8.5616]
    ,[47.4536, 8.5615]
    ,[47.4535, 8.5615]
    ,[47.4536, 8.5611]
    ,[47.4535, 8.5611]
    ,[47.4528, 8.5614]
    ,[47.4529, 8.5611]
    ,[47.4528, 8.5612]
    ,[47.4531, 8.5612]
    ,[47.453, 8.561]
    ,[47.4531, 8.5607]
,[47.453, 8.5608]
,[47.4527, 8.5608]
,[47.4526, 8.5608]
,[47.4527, 8.5608]
,[47.4528, 8.5609]
,[47.4526, 8.5609]
,[47.451, 8.5611]
,[47.4512, 8.561]
,[47.4512, 8.5612]
,[47.451, 8.5611]
,[47.4515, 8.5613]
,[47.4519, 8.5613]
,[47.4517, 8.5611]
,[47.4518, 8.561]
,[47.4521, 8.5611]
,[47.452, 8.5612]
,[47.4518, 8.5611]
,[47.4518, 8.5613]
,[47.4517, 8.5614]
,[47.4509, 8.561]
,[47.4512, 8.5587]
,[47.4513, 8.5585]
,[47.4513, 8.5607]
,[47.4516, 8.5608]
,[47.4515, 8.5608]
,[47.4513, 8.5608]
,[47.4513, 8.5607]
,[47.4504, 8.5602]
,[47.4507, 8.5603]
,[47.4508, 8.5602]
,[47.4506, 8.5602]
,[47.4505, 8.5603]
,[47.4504, 8.5603]
,[47.4507, 8.5602]
,[47.4504, 8.5613]
,[47.4507, 8.5613]
,[47.4502, 8.5613]
,[47.4511, 8.5614]
,[47.451, 8.5614]
,[47.4508, 8.5613]
,[47.4507, 8.5613]
,[47.4504, 8.5614]
,[47.4503, 8.5613]
  ];

    initialDetecetionsPositions_SecondFloor = [
      [49.606945, 8.368333],
      [50.98194, 12.50638],
      [51.83169, 12.19096],
      [52.19585, 14.58753],
      [51.30805, 13.55555],
      [51.36305, 11.94083],
      [51.55222, 12.05388],
      [51.29360, 13.35611],
      [53.30638, 12.75222],
      [52.58055, 13.91666],
      [52.20360, 13.15638],
      [54.03825, 12.71051],
      [50.91527, 11.71444],
      [52.91888, 12.42527],
      [52.07361, 11.62638],
      [51.36333, 14.94999],
      [53.83277, 13.66861],
      [51.88944, 14.53194],
      [51.29694, 14.12749],
      [52.38000, 13.52250],
      [51.13280, 13.76720],
      [50.97980, 10.95810],
      [50.02233, 8.57055],
      [52.13460, 7.68482],
      [53.63040, 9.98822],
      [52.47259, 13.40390],
      [50.86589, 7.14273],
      [51.22701, 6.76677],
      [48.35380, 11.7861],
      [49.49869, 11.07805],
      [51.42388, 12.23308],
      [49.21459, 7.10950],
      [48.68989, 9.22196],
      [52.35970, 13.28769],
      [52.46110, 9.68479],
      [53.04750, 8.78665],
      [49.69999, 8.64583],
      [49.94869, 7.26388],
      [49.47305, 8.51416],
      [51.03499, 8.68083]
    ];


// create markers
initialDetecetionsPositions_FirstFloor.forEach(function(pos) {
      markers_FirstFloor.push(new H.map.DomMarker({lat: pos[0], lng: pos[1]}, {
        icon: domIcon
      }));
    });

    //markers_FirstFloor_Unchanged = markers_FirstFloor;

        // add markers to map
        map.addObjects(markers_FirstFloor);
        
        //logic to add map object (marker) to the current active venue
        venuesProvider.activeVenue.setMapObjects(
          markers_FirstFloor,
          venuesProvider.activeVenue.getActiveLevelIndex(),
          venuesProvider.activeVenue.getActiveDrawing()
        );

    // randomly update all markers positions in intervals
    setTimeout(updateMarkerPositions, 500);
    setInterval(updateMarkerPositions, 5000);


        /**
    * update all markers' positions with animation using the ease function
     */
     function updateMarkerPositions() {
      markers_FirstFloor.forEach(function(marker) {
        
        //console.log('Hollla');

        var randomIndex = Math.floor(Math.random() * initialDetecetionsPositions_FirstFloor.length);
        let randomPoint = {lat: initialDetecetionsPositions_FirstFloor[randomIndex][0], lng: initialDetecetionsPositions_FirstFloor[randomIndex][1]}; 
        
        //console.log(`Random index = ${randomIndex}`);
        //let randomPoint = {lat: initialDetecetionsPositions_FirstFloor[randomIndex][0], lng: initialDetecetionsPositions_FirstFloor[randomIndex][1]}; 
        // let randomPoint = markers_FirstFloor_Unchanged[Math.floor(Math.random() * markers_FirstFloor_Unchanged.length)]; 
        
        // get random position 0 - x km (450/1000 km) from map's center in random direction
        //let randomPoint = map.getCenter().walk(Math.random() * 360, Math.random() * 450);

        // update marker's position within ease function callback
        ease(
          marker.getGeometry(),
          randomPoint,
          4000,
          function(coord) {
            marker.setGeometry(coord);
          }
        )
      });
    }


  } catch (error) {
    console.error(error);
  }
}




/**
 * Ease function
 * @param   {H.geo.IPoint} startCoord   start geo coordinate
 * @param   {H.geo.IPoint} endCoord     end geo coordinate
 * @param   number durationMs           duration of animation between start & end coordinates
 * @param   function onStep             callback executed each step
 * @param   function onStep             callback executed at the end
 */
 function ease(
  startCoord = {lat: 0, lng: 0},
  endCoord = {lat: 1, lng: 1},
  durationMs = 200,
  onStep = console.log,
  onComplete = function() {},
) {
  var raf = window.requestAnimationFrame || function(f) {window.setTimeout(f, 16)},
      stepCount = durationMs / 16,
      valueIncrementLat = (endCoord.lat - startCoord.lat) / stepCount,
      valueIncrementLng = (endCoord.lng - startCoord.lng) / stepCount,
      sinValueIncrement = Math.PI / stepCount,
      currentValueLat = startCoord.lat,
      currentValueLng = startCoord.lng,
      currentSinValue = 0;

  function step() {
    currentSinValue += sinValueIncrement;
    currentValueLat += valueIncrementLat * (Math.sin(currentSinValue) ** 2) * 2;
    currentValueLng += valueIncrementLng * (Math.sin(currentSinValue) ** 2) * 2;

    if (currentSinValue < Math.PI) {
      onStep({lat: currentValueLat, lng: currentValueLng});
      raf(step);
    } else {
      onStep(endCoord);
      onComplete();
    }
  }

  raf(step);
}

function addChart(){
var chartLabels = [];
var chartData = [];

var detectionsTypesCounts = getDetectionsTypesCounts(initialDetections.WaliedCheetos.detections);
var detectionsSubTypesCounts = getDetectionsSubTypesCounts(initialDetections.WaliedCheetos.detections);

Object.keys(detectionsTypesCounts).forEach(function(key) {
    console.log(key, detectionsTypesCounts[key]);
    chartLabels.push(key);
    chartData.push(detectionsTypesCounts[key]);
});

  var ctx = document.getElementById('chart_DetectionsTypesCounts');

chart_DetectionsTypesCounts = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: chartLabels,
        datasets: [{
            label: 'Detections types per floor',
            data: chartData,
            borderWidth: 1,
            backgroundColor: [
      'rgb(255, 99, 132)',
      'rgb(75, 192, 192)',
      'rgb(255, 205, 86)',
      'rgb(201, 203, 207)',
      'rgb(54, 162, 235)'
    ]
        }]
    },
    options: {
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});


  chartLabels.splice(0, chartLabels.length);
   chartData.splice(0, chartData.length);

Object.keys(detectionsSubTypesCounts).forEach(function(key) {
    console.log(key, detectionsSubTypesCounts[key]);
    chartLabels.push(key);
    chartData.push(detectionsTypesCounts[key]);
});

ctx = document.getElementById('chart_DetectionsSubTypesCounts');

chart_DetectionsSubTypesCounts = new Chart(ctx, {
    type: 'polarArea',
    data: {
        labels: chartLabels,
        // legend: {
        //         display: true,
        //         position: 'right'
        //     },
        datasets: [{
            label: 'Detections sub-types per floor',
            data: chartData,
            hoverOffset: 4,
            backgroundColor: [
      'rgb(255, 99, 132)',
      'rgb(75, 192, 192)',
      'rgb(255, 205, 86)',
      'rgb(201, 203, 207)',
      'rgb(54, 162, 235)'
    ]
        }]
      
    }
    
});

}


/**
 * Add locations markers in HERE venues data on the map
 *
 * @param  {H.Map} map A HERE Map instance
 */
function addVenueLocations() {
// function addVenueLocations(venuesProvider, venueId) {
  try {

    console.log(`this active venue has ${venuesProvider.getActiveVenue().search('Bathroom').length} number of bathrooms`);

    venuesProvider.getActiveVenue().setHighlightedGeometries(
      true,
      venuesProvider.getActiveVenue().search('Bathroom'),{
        fillColor: 'red',
        outlineColor: 'black',
        outlineWidth: 8
      });

    venuesProvider.getActiveVenue().search('Bathroom').forEach(element => {
      console.log(`Bathroom object: ${JSON.stringify(element.toGeoJSON())}`);

      //element.getData().properties.display_name
      //element.getData().properties.facility
      //element.getData().id
      // element.getData().geometry
      // element.getData().level.properties.zlevel
      // element.getData().level.properties.name
      // element.getData().level.properties.type
      // element.getData().zIndex
    });


    console.log('WaliedCheetos');

  } catch (error) {
    console.error(error);
  }
  // try {
  //   // const venue = venuesProvider.getVenue(venueId);
  //   const venuesService = platform.getVenuesService({ apikey: 'QICW7garcjxE7C7sSguJcNolMZXqYCJ9m5o6Qq3ygjg' });
  //   const venue = venuesProvider.getVenue(7348);

  //   console.log('WaliedCheetos');

  // } catch (error) {
  //   console.error(error);
  // }
}

/**
 * Load and add venue data on the map.
 *
 * @param  {H.Map} map A HERE Map instance
 */
function addVenueToMap(map) {
  // Get instance of venues service using valid apikey for venues
  // const venuesService = platform.getVenuesService({ apikey: 'pmYeJOpIGhJHSyyizwSKKPJoAHdjJ_bj12yfckgiT4E' });
  

  // // Venues provider interacts with tile layer to visualize and control the venue map
  // const venuesProvider = new H.venues.Provider();

  // Venues service provides a loadVenue method
  venuesService.loadVenue(7348).then((venue) => {
  //venuesService.loadVenue(10635).then((venue) => {
    // add venue data to venues provider
    venuesProvider.addVenue(venue);
    venuesProvider.setActiveVenue(venue);

    // create a tile layer for the venues provider
    map.addLayer(new H.map.layer.TileLayer(venuesProvider));

    // optionally select drawing/level
    venue.setActiveDrawing(7880);

    // create level control
    const levelControl = new H.venues.ui.LevelControl(venue);
    ui.addControl('level-control', levelControl);

    // create drawing control:
    const drawingControl = new H.venues.ui.DrawingControl(venue);
    ui.addControl('drawing-control', drawingControl);

      // center map on venue
  //map.setCenter(venue.getCenter());

   // get the shape's bounding box and adjust the camera position
   map.getViewModel().setLookAtData({
      //zoom: evt.target.getData().minZoom,
      bounds: venue.getBoundingBox()
    }, true);

    addDetections();

    //createMarkers();

  //register on venue level change event
    venue.addEventListener(H.venues.Venue.EVENTS.LEVEL_CHANGE, (event) => {
      onVenueLevelChange(event);
});

// venue.getGeometries().forEach((venueGeomtry)=>{
//   venueGeomtry.addEventListener('tap', (event) => {
//       console.log(event);
// });
// });

  });
}

function onVenueLevelChange(event){
  try {
    //console.log(event);
    var currentLevelDetections = detections.WaliedCheetos.detections.filter(detection => detection.location.venue_info.level === event.newValue);
    console.log(`floor # ${event.newValue} has ${currentLevelDetections.length} detections!`);

    var detectionsTypesCounts = getDetectionsTypesCounts(currentLevelDetections);
    console.log(detectionsTypesCounts);

  } catch (error) {
    console.error(error);
  }
}

function getDetectionsTypesCounts(input) {
  var arr = input, obj = {};
  for (var i = 0; i < arr.length; i++) {
    if (!obj[arr[i].object.type]) {
      obj[arr[i].object.type] = 1;
    } else if (obj[arr[i].object.type]) {
      obj[arr[i].object.type] += 1;
    }
  }
  return obj;
}

function getDetectionsSubTypesCounts(input) {
  var arr = input, obj = {};
  for (var i = 0; i < arr.length; i++) {
    if (!obj[arr[i].object.subtype]) {
      obj[arr[i].object.subtype] = 1;
    } else if (obj[arr[i].object.subtype]) {
      obj[arr[i].object.subtype] += 1;
    }
  }
  return obj;
}

var arr = []

/**
 * An event listener is added to listen to tap events on the map.
 * Clicking on the map displays an alert box containing the latitude and longitude
 * of the location pressed.
 * @param  {H.Map} map      A HERE Map instance within the application
 */
 function setUpMapClickListener(map) {

try{

            // Attach an event listener to map display
            // obtain the coordinates and display in an alert box.
            map.addEventListener('tap', function (evt) {



                    var coord = map.screenToGeo(evt.currentPointer.viewportX,
                        evt.currentPointer.viewportY);

if(_marker == null){
  _marker = new H.map.Marker(
                        {
                            lat: coord.lat,
                            lng: coord.lng
                        }, {
                        // mark the object as volatile for the smooth dragging
                        volatility: true,
                        //set customer icon to the marker
                        icon: new H.map.Icon("../../../images/marker_position.png", { size: { w: 33, h: 33 } })
                    });
                    map.addObject(_marker);
                  }
                  else{
                    _marker.setGeometry({lat: coord.lat, lng: coord.lng});
                  }

                  arr.push([Math.abs(coord.lat.toFixed(4)),
                     Math.abs(coord.lng.toFixed(4))]);
                    // console.log('Clicked at ' + Math.abs(coord.lat.toFixed(4)) +
                    //     ((coord.lat > 0) ? 'N' : 'S') +
                    //     ' ' + Math.abs(coord.lng.toFixed(4)) +
                    //     ((coord.lng > 0) ? 'E' : 'W'));

                    console.log(Math.abs(coord.lat.toFixed(4)),
                     Math.abs(coord.lng.toFixed(4))
                    );

console.log (arr);

                        //logic to add map object (marker) to the current active venue
venuesProvider.activeVenue.setMapObjects(map.getObjects(), venuesProvider.activeVenue.getActiveLevelIndex(), venuesProvider.activeVenue.getActiveDrawing());

console.log(`WaliedCheetos: get active venue map objects - $venuesProvider.activeVenue.getMapObjects()`);


            });
          } catch (error) {
    console.error(error);
  }
}



//#endregion


/**
 * Boilerplate map initialization code starts below:
 */

// Step 1: initialize communication with the platform
// In your own code, replace variable window.apikey with your own apikey
var platform = new H.service.Platform({
  apikey: 'pmYeJOpIGhJHSyyizwSKKPJoAHdjJ_bj12yfckgiT4E',
  ln:"ara"
});
var defaultLayers = platform.createDefaultLayers();

// Step 2: initialize a map
var map = new H.Map(document.getElementById('map'), defaultLayers.vector.normal.map, {
  zoom: 17,
  // center: { lat: 47.452353, lng: 8.562455 },
  center:{lat:24.9599418, lng:55.1475067},

  // center: {lat: 50.90978, lng: 10.87203},
  // zoom: 6,
  pixelRatio: window.devicePixelRatio || 1
});

// add a resize listener to make sure that the map occupies the whole container
window.addEventListener('resize', () => map.getViewPort().resize());

// Step 3: make the map interactive
// MapEvents enables the event system
// Behavior implements default interactions for pan/zoom (also on mobile touch environments)
var behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));

// Step 4: create the default UI component, for displaying bubbles
var ui = H.ui.UI.createDefault(map, defaultLayers);

        //#region add new UI element

        inherits = function (childCtor, parentCtor) {
            function tempCtor() { } tempCtor.prototype = parentCtor.prototype; childCtor.superClass_ = parentCtor.prototype; childCtor.prototype = new tempCtor(); childCtor.prototype.constructor = childCtor; childCtor.base = function (me, methodName, var_args) {
                var args = new Array(arguments.length - 2);
                for (var i = 2; i < arguments.length; i++) {
                    args[i - 2] = arguments[i];
                }
                return parentCtor.prototype[methodName].apply(me, args);
            };
        };

        var customUI = function (opt_options) {
            'use strict'; var options = opt_options || {};

            H.ui.Control.call(this);
            this.onButtonClick = this.onButtonClick.bind(this);

            // create a button element   
            this.increaseBtn_ = new H.ui.base.Button({
                'label': `<svg xmlns="http://www.w3.org/2000/svg" version="1.1" class="H_icon H_icon" viewBox="0 0 25 25"> 
<g fill="none" stroke-width="3" transform="translate(11,11)">
<circle id="my-circle" cx="0" cy="0" r="11" stroke="darkorange" fill="seagreen" />
<animate href="#my-circle" attributeName="opacity"  values="1;-2" dur="1s" repeatCount="indefinite" /> </g> </svg>`,

                'onStateChange': this.onButtonClick
                // 'label': '<svg class="H_icon H_icon" viewBox="0 0 25 25">' +
                //     '<path d="M 18.5,11 H 14 V 6.5 c 0,-.8 -.7,-1.5 -1.5,-1.5 -.8,0 -1.5,.7 -1.5,1.5 V 11 H 6' +
                //     '.5 C 5.7,11 5,11.7 5,12.5 5,13.3 5.7,14 6.5,14 H 11 v 4.5 c 0,.8 .7,1.5 1.5,1.5 .8,0 1.5,' +
                //     '-.7 1.5,-1.5 V 14 h 4.5 C 19.3,14 20,13.3 20,12.5 20,11.7 19.3,11 18.5,11 z" />' +
                //     '</svg>',
                // 'onStateChange': this.onButtonClick
            });

            //add the buttons as this control's children   
            this.addChild(this.increaseBtn_);

            this.setAlignment(options['alignment'] || 'top-right');

            this.options_ = options;
        };
        inherits(customUI, H.ui.Control);

        customUI.prototype.onButtonClick = function (evt) {
            'use strict'; if (evt.currentTarget.getState() === 'down') {
                console.log('Hollla, I am the new custom UI element.');
            }
        };

        var WaliedCheetos_CustomUI = new customUI();
        ui.addControl('WaliedCheetos_CustomUI', WaliedCheetos_CustomUI);

        //#endregion


  // Venues provider interacts with tile layer to visualize and control the venue map
  const venuesProvider = new H.venues.Provider();
  const venuesService = platform.getVenuesService({ apikey: 'QICW7garcjxE7C7sSguJcNolMZXqYCJ9m5o6Qq3ygjg' });
  
  var _marker;

// Step 4: register map ontap event
//setUpMapClickListener(map);

// Step 5: load venue data
addVenueToMap(map);
addChart();

//createMarkers();
//addDetections();
//setInterval(updateMarkerPositions(markers_FirstFloor), 5000);

    </script>
  </body>
</html>